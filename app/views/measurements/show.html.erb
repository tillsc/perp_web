<%= stylesheet_link_tag 'measurements' %>

<h4>
  Rennen <%= @race.event.number %> - <%= @race.name %> bei <%= @measuring_point.name %>
</h4>
<p><small>
  <% if @race.event.measuring_point_type(@measuring_point) != :start %>
    Gestartet:
      <% if @race.started_at %>
        <time id="started_at" datetime="<%=  @race.started_at %>"><%= l(@race.started_at, format: :short) %></time>
      <% else %>
        -
      <% end %>
  <% elsif @race.started_at %>
    Vorhandene Startzeit: <time datetime="<%=  @race.started_at %>"><%= l(@race.started_at, format: :short) %></time>
  <% end %>
</small></p>


<%= form_tag measurement_path(@regatta, race_number: @race.number, event_number: @race.event.number) do %>
  <% if @measuring_session.present? %>
    <%= hidden_field_tag :measuring_session_id, @measuring_session&.to_param %>
  <% end %>
  <%= hidden_field_tag :measuring_point_number, params[:measuring_point_number] %>

  <div class="participants_and_times <%= "hide_team_name" if @race.event.measuring_point_type(@measuring_point) != :start  %>">
    <div>
      <h6>
        <% if @race.event.measuring_point_type(@measuring_point) != :start %>
          Reihenfolge
        <% else %>
          Bahnbelegung
        <% end %>
      </h6>
      <div id="participants" class="item_list">
        <% @measurements.keys.each do |p| %>
          <%= render 'participant', participant: p, measuring: @measuring %>
        <% end %>
      </div>
    </div>

    <div>
      <h6>Zeiten</h6>
      <div id="times" class="item_list" <%= "data-edit-times" if can?(:manage, MeasurementSet) %>>
        <% @measurements.values.each do |time| %>
            <%= hidden_field_tag 'times[]', time %>
        <% end %>
      </div>
    </div>
  </div>

  <%= submit_tag "Fertig", class: 'btn btn-success' %>
  <%= link_to "Zeit Stoppen", '#', id: 'stop_time', class: 'btn btn-primary' %>

<% end %>

<h6 class="mt-1">Verf√ºgbare Boote</h6>
<div id="available_participants" class="item_list">
  <% @measuring.other_active_participants.each do |p| %>
    <%= render 'participant', participant: p, measuring: @measuring %>
  <% end %>
  <% if @measuring.other_participants.any? %>
    <% if @measuring.other_active_participants.any? %>
      <h3 class="item_list__item h-auto sub-header">Andere Teilnehmer</h3>
    <% end %>
    <% @measuring.other_participants.each do |p| %>
      <%= render 'participant', participant: p, measuring: @measuring %>
    <% end %>
  <% end %>
</div>

<% if @measuring_session %>
  <h6 class="mt-1">Mess-Sitzung</h6>
  <%= link_to @measuring_session.identifier, measuring_session_url(@regatta, @measuring_session) %>
  (<%= @measuring_session.device_description %>@<%= @measuring_session.measuring_point.name %> - <%= @measuring_session.active? ? 'Aktiv' : 'Nicht aktiv' %>)
<% end %>
<% if can?(:show, :measurements_history) && @measurements_history.present? %>
  <h5 class="mt-4">Historie</h5>
  <% @measurements_history.reverse_each do |date, data| %>
    <h6><%= date && l(DateTime.parse(date), format: :full) %></h6>
    <div class="d-flex justify-content-between">
    <% data.each do |k, v| %>
      <div class="border p-3 bg-light">
        <%= @measuring.find_participant(k)&.number || "TNR#{k}" %>:
        <%= v %>
      </div>
    <% end %>
    </div>
  <% end %>
<% end %>

<script>
  cancelAutoreload();
</script>
<%= javascript_include_tag 'measurements' %>